#!/usr/bin/env node

import { readFileSync, writeFileSync, existsSync } from "node:fs";
import { resolve, dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const repoRoot = resolve(__dirname, "..");
const fluxPkgPath = resolve(repoRoot, "node_modules/@flux-lang/core/package.json");
const fluxMetaPath = resolve(repoRoot, "src/lib/fluxMeta.ts");

function ensureFallbackMeta() {
  const fallback = `// Fallback metadata for Flux version.
// This file will be overwritten by scripts/sync-flux-version.mjs when @flux-lang/core is installed.

export const fluxVersion = "0.0.0";
export const fluxRepoUrl = "https://github.com/cbassuarez/flux";
export const fluxRepoPermalink = fluxRepoUrl;
`;
  writeFileSync(fluxMetaPath, fallback);
  console.warn(`[sync-flux-version] Wrote fallback ${fluxMetaPath}`);
}

function main() {
  if (!existsSync(fluxPkgPath)) {
    console.warn(
      `[sync-flux-version] Could not find ${fluxPkgPath}. ` +
      `Make sure @flux-lang/core is installed before running the build.`
    );
    if (!existsSync(fluxMetaPath)) {
      ensureFallbackMeta();
    }
    // Do not fail the build â€“ just warn.
    process.exit(0);
  }

  const pkg = JSON.parse(readFileSync(fluxPkgPath, "utf8"));
  const version = pkg.version || "0.0.0";

  const fluxRepoUrl = "https://github.com/cbassuarez/flux";
  const tag = `v${version}`;
  const fluxRepoPermalink = `${fluxRepoUrl}/tree/${tag}`;

  const contents = `// This file is generated by scripts/sync-flux-version.mjs
// Do not edit by hand.

export const fluxVersion = "${version}";
export const fluxRepoUrl = "${fluxRepoUrl}";
export const fluxRepoPermalink = "${fluxRepoPermalink}";
`;

  writeFileSync(fluxMetaPath, contents);
  console.log(
    `[sync-flux-version] Updated ${fluxMetaPath} to Flux version ${version}`
  );
}

main();
